#!/bin/bash

echo Prepare database configuration...

(umask 077 ; touch infrastructure/.env)
(umask 077 ; touch src/config.ini)

read -sp "Set root password: " rootpassvar
echo
read -sp "Repeat root password: " rootpasscmp
echo

if [ "$rootpassvar" != "$rootpasscmp" ]
then
    echo root passwords not equal
    exit 1
fi

read -p "Username: " uservar
if [[ -z "$uservar" ]]
then
    echo no username set
    exit 1
fi
read -sp "Set password for user $uservar: " userpassvar
echo
read -sp "Repeat password for user $uservar: " userpasscmp
echo

if [ "$userpassvar" != "$userpasscmp" ]
then 
    echo user passwords not equal
    exit 1
fi

echo ...

echo MYSQL_ROOT_PASSWORD=$rootpassvar > infrastructure/.env
echo MYSQL_USER=$uservar >> infrastructure/.env
echo MYSQL_PASSWORD=$userpassvar >> infrastructure/.env

echo Docker-compose environment variables set

echo ...

echo [MySQL Auth] > src/config.ini
echo host = auth_db >> src/config.ini
echo user = $uservar >> src/config.ini
echo port = 3306 >> src/config.ini
echo passwd = $userpassvar >> src/config.ini
echo database = auth >> src/config.ini
echo >> src/config.ini


echo ...

echo [MySQL Data] >> src/config.ini
echo host = data_db >> src/config.ini
echo user = $uservar >> src/config.ini
echo port = 3306 >> src/config.ini
echo passwd = $userpassvar >> src/config.ini
echo database = testdb >> src/config.ini
echo >> src/config.ini

echo database configuration finished.

read -p "Enter bot token: " token
if [[ -z "$token" ]]
then
    echo no token provided
    exit 1
fi

read -sp "Enter password for bot: " botpassvar
echo 
read -sp "Repeat password for bot: " botpasscmp
if [ "$botpassvar" != "$botpasscmp" ]
then 
    echo bot passwords not equal
    exit 1
fi

echo ...

echo [Bot] >> src/config.ini
echo token = $token >> src/config.ini
echo >> src/config.ini

echo [Authentication] >> src/config.ini
echo password = $botpassvar >> src/config.ini

echo bot configuration finished

echo [GameCategories] >> src/config.ini
echo Default categories for games are: groß, klein, Würfel, Rollenspiel, Karten, Worker Placement.
echo Having categories \'groß\' and \'klein\' is mandatory, but if you wish, you can change the rest. 
read -p "Enter a category you want to add (press Return to stay with default values): " newcategory
if [[ -z "$newcategory" ]]
then
    echo categories = groß, klein, Würfel, Rollenspiel, Karten, Worker Placement >> src/config.ini
else
    echo -n categories = groß, klein, $newcategory >> src/config.ini
    while [[ -n "$newcategory" ]]
    do
        read -p "Add another category to add (press Return to stop): " newcategory
        if [[ -z "$newcategory" ]]
        then
			echo >> src/config.ini
        else
            echo -n , $newcategory >> src/config.ini
        fi
    done
fi
echo categories defined